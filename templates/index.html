{% extends "base.html" %}
{% block content %}

<!-- Labs pill shown at top of content area -->
<div class="container nav-pill-row" style="max-width:980px; margin:8px auto 0; padding:0 12px;">
  <div class="nav-links-row">
    <a class="btn btn-ghost" href="{{ url_for('labs') }}">üß™ Labs</a>
  </div>
</div>

<section class="hero">
  <div class="hero-inner">
    <h1 class="hero-title">Explore Blockchain & Smart Contracts</h1>
    <p class="hero-subtitle">We build knowledge around smart contracts, security audits, and research that bridges blockchain with space innovation.</p>
    <div class="cta-row">
      <a class="btn btn-primary" href="{{ url_for('blockchain_basic') }}">Blockchain Basic</a>
      <a class="btn btn-ghost" href="javascript:void(0)" onclick="openReview()">Review</a>
    </div>
  </div>
</section>

<div class="home-cards" id="cards-root">
  <!-- Four new buttons as requested -->
  <div class="card" style="cursor:pointer" onclick="showDetail('ai')">
    <h2>Ai Agents</h2>
    <p>Autonomous on-chain/off-chain agents that monitor, act and optimise smart contract systems.</p>
  </div>

  <div class="card" style="cursor:pointer" onclick="showDetail('multisign')">
    <h2>Multisign</h2>
    <p>Multi-signature wallets and workflows for safer treasury and admin operations.</p>
  </div>

  <div class="card" style="cursor:pointer" onclick="showDetail('dao')">
    <h2>DAO</h2>
    <p>Decentralized Autonomous Organizations ‚Äî governance, treasury, and community coordination.</p>
  </div>

  <div class="card" style="cursor:pointer" onclick="showDetail('future')">
    <h2>Future of Blockchain Technology</h2>
    <p>Trends: Ai integration, ZK privacy, cross-chain, tokenization, and space-grade deployments.</p>
  </div>
</div>

<!-- Details panels (hidden by default) -->
<div id="detail-root" style="margin-top:18px; display:none;">
  <div class="card" id="detail-ai" style="display:none;">
    <a href="javascript:void(0)" onclick="hideDetail()" style="float:right; color:var(--muted); text-decoration:none;">Back</a>
    <h2>Ai Agents ‚Äî Autonomous Intelligent Agents</h2>
    <p style="color:var(--muted);">Ai Agents are software entities that observe data, make decisions, and act ‚Äî optionally interacting with blockchains or smart contracts. They can automate monitoring, on-chain operations, trading strategies, security scanning and governance helpers.</p>
    <h4 style="color:#6a5cff; margin-top:8px;">Key uses</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>Real-time on-chain monitoring and anomaly detection.</li>
      <li>Autonomous rebalancing, arbitrage and DeFi optimisation.</li>
      <li>Automated vulnerability triage and alerting for auditors.</li>
      <li>Agent-assisted DAO proposal evaluation and recommendation.</li>
    </ul>
    <h4 style="color:#2ad1ff; margin-top:8px;">Design & risks</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>Keep transparent decision logs on-chain or via signed attestations.</li>
      <li>Protect agent keys; use threshold keys or multisig for critical actions.</li>
      <li>Rate-limit and test agent policies to avoid costly on-chain mistakes.</li>
    </ul>
  </div>

  <div class="card" id="detail-multisign" style="display:none;">
    <a href="javascript:void(0)" onclick="hideDetail()" style="float:right; color:var(--muted); text-decoration:none;">Back</a>
    <h2>Multisign ‚Äî Multi-signature Security</h2>
    <p style="color:var(--muted);">Multisig requires multiple independent signatures to authorize transactions. It is widely used to secure treasuries, protect admin privileges, and ensure collective control over funds.</p>
    <h4 style="color:#6a5cff; margin-top:8px;">Common patterns</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>m-of-n wallets (example: 2/3, 3/5) for team custody.</li>
      <li>Multisig with timelocks and on-chain guardians for safer upgrades.</li>
      <li>DAOs integrating multisig for delegated execution of proposals.</li>
    </ul>
    <h4 style="color:#2ad1ff; margin-top:8px;">Best practices</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>Use tested multisig contracts (OpenZeppelin/Gnosis Safe).</li>
      <li>Distribute keys across people and devices; avoid single points of failure.</li>
      <li>Combine with monitoring, alerts and emergency recovery plans.</li>
    </ul>
  </div>

  <div class="card" id="detail-dao" style="display:none;">
    <a href="javascript:void(0)" onclick="hideDetail()" style="float:right; color:var(--muted); text-decoration:none;">Back</a>
    <h2>DAO ‚Äî Decentralized Autonomous Organization</h2>
    <p style="color:var(--muted);">A DAO is an on-chain governed collective where rules and treasury actions are enforced by smart contracts. Members propose and vote; successful proposals execute automatically when conditions are met.</p>
    <h4 style="color:#6a5cff; margin-top:8px;">Core components</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>Token-based voting or reputation systems for decision power.</li>
      <li>Proposal lifecycle (create ‚Üí discuss ‚Üí vote ‚Üí execute).</li>
      <li>Treasury contracts, multisig safes, and timelocks for finance control.</li>
    </ul>
    <h4 style="color:#2ad1ff; margin-top:8px;">Operational notes</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>Design clear proposal formats and quorum rules.</li>
      <li>Use on-chain and off-chain governance tooling (forum, snapshot, on-chain execution).</li>
      <li>Audit governance contracts and treasury flows thoroughly.</li>
    </ul>
  </div>

  <div class="card" id="detail-future" style="display:none;">
    <a href="javascript:void(0)" onclick="hideDetail()" style="float:right; color:var(--muted); text-decoration:none;">Back</a>
    <h2>Future of Blockchain Technology</h2>
    <p style="color:var(--muted);">The near future blends privacy (ZK), Ai, cross-chain interoperability, tokenization of real-world assets, and niche domains like space-grade decentralized systems ‚Äî producing richer, privacy-preserving and highly interconnected infrastructures.</p>
    <h4 style="color:#6a5cff; margin-top:8px;">Major trends</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>Ai + blockchain: autonomous agents, predictive contracts, on-chain ML pointers.</li>
      <li>Zero-knowledge proofs for private computation and confidential state.</li>
      <li>Seamless cross-chain execution and universal liquidity layers.</li>
      <li>Tokenization and regulated on-chain RWAs (real-world assets).</li>
      <li>Space-oriented deployments: low-bandwidth anchoring, satellite relays, provenance for telemetry.</li>
    </ul>
    <h4 style="color:#2ad1ff; margin-top:8px;">How to prepare</h4>
    <ul style="color:var(--muted); font-size:13px;">
      <li>Learn ZK basics, cross-chain primitives and secure oracle design.</li>
      <li>Adopt modular, audited toolchains and privacy-first patterns.</li>
      <li>Design for resilience and intermittent connectivity in novel domains (eg. space).</li>
    </ul>
  </div>
</div>

<div class="latest">
  <h2>Latest</h2>
  <p class="muted">Updates and short notes will appear here.</p>
</div>

<!-- REVIEW MODAL (no reset-name option) -->
<div id="review-modal" style="display:none; position:fixed; inset:0; z-index:9999; justify-content:center; align-items:center; background:rgba(0,0,0,0.6);">
  <div style="width:92%; max-width:520px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:var(--shadow); color:var(--text);">

    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0; font-size:16px;">Write Your Review</h3>
      <button onclick="closeReview()" style="background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer;">‚úï</button>
    </div>

    <p id="rv-instructions" style="margin:8px 0 12px; color:darkgreen; font-size:13px;">Type your name once (saved to this device), then write your review. Captcha is required to create review.</p>

    <input id="review-name" placeholder="Type your name" style="width:100%; padding:10px; border-radius:8px; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04);">
    <div id="review-name-note" style="font-size:13px; color:var(--muted); margin-top:8px;">You can set name only once on this device/browser.</div>

    <div id="rv-captcha-row" style="display:flex; gap:8px; margin-top:10px; align-items:center;">
      <div id="rv-captcha-question" style="color:darkgreen; font-size:13px;">&nbsp;</div>
      <input id="rv-captcha-answer" placeholder="Answer" style="padding:8px; border-radius:8px; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04); width:120px;">
      <button id="rv-new-captcha" onclick="fetchCaptcha()" style="padding:8px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text);">New</button>
    </div>

    <textarea id="review-text" rows="4" placeholder="Write your review..." style="width:100%; padding:10px; border-radius:8px; margin-top:12px; background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04);"></textarea>

    <div style="display:flex; gap:8px; margin-top:12px;">
      <button id="rv-publish" onclick="submitReview()" style="flex:1; padding:10px; border-radius:8px; background:linear-gradient(135deg,#6a5cff,#2ad1ff); color:#041028; font-weight:700; border:none;">Add your review</button>
    </div>

    <div id="review-list" style="margin-top:12px; max-height:300px; overflow:auto;"></div>
  </div>
</div>

<!-- small JS to toggle + review logic -->
<script>
  function showDetail(id){
    // hide cards, show detail-root and the requested panel
    document.getElementById('cards-root').style.display = 'none';
    var root = document.getElementById('detail-root');
    root.style.display = 'block';
    ['ai','multisign','dao','future'].forEach(function(k){
      var el = document.getElementById('detail-' + k);
      if(!el) return;
      el.style.display = (k === id) ? 'block' : 'none';
    });
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  function hideDetail(){
    document.getElementById('detail-root').style.display = 'none';
    document.getElementById('cards-root').style.display = 'grid';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  /* --- Review widget (no reset-name) --- */
  const API_BASE = '/api/reviews';
  const NAME_KEY = 'aj_name_v1';
  const REV_KEY = 'aj_reviews_v1_fallback';
  const DELETE_MAP_KEY = 'aj_rev_delete_map_v1';
  let serverAvailable = null;

  function openReview(){
    loadNameState();
    detectServerThenLoad();
    document.getElementById('review-modal').style.display='flex';
  }
  function closeReview(){ document.getElementById('review-modal').style.display='none'; }

  function loadNameState(){
    const n = localStorage.getItem(NAME_KEY);
    const input = document.getElementById('review-name');
    const note = document.getElementById('review-name-note');
    if(n){ input.value=n; input.disabled=true; note.innerHTML='Name saved: <span style="color:red;">'+n+'</span>'; }
    else{ input.value=''; input.disabled=false; note.innerText='You can set name only once on this device/browser.'; }
  }

  async function detectServerThenLoad(){
    try{
      const res = await fetch(API_BASE + '/health', {cache:'no-store'});
      if(res.ok){ serverAvailable = true; await fetchCaptcha(); await loadServerReviews(); return; }
    }catch(e){}
    try{
      const res = await fetch(API_BASE + '?limit=1', {cache:'no-store'});
      if(res.ok){ serverAvailable = true; await fetchCaptcha(); await loadServerReviews(); return; }
    }catch(e){}
    serverAvailable = false;
    fetchCaptchaFallback();
    loadFallbackReviews();
  }

  async function fetchCaptcha(){
    if(serverAvailable===false) return fetchCaptchaFallback();
    try{
      const r = await fetch(API_BASE + '/captcha', {cache:'no-store'});
      if(!r.ok) throw new Error('no captcha');
      const j = await r.json();
      document.getElementById('rv-captcha-question').innerText = j.question || '';
      document.getElementById('rv-captcha-question').dataset.cid = j.cid || '';
    }catch(e){
      serverAvailable = false;
      fetchCaptchaFallback();
    }
  }

  function fetchCaptchaFallback(){
    const a = Math.floor(Math.random()*8)+2;
    const b = Math.floor(Math.random()*8)+1;
    document.getElementById('rv-captcha-question').innerText = `${a} + ${b} = ?`;
    document.getElementById('rv-captcha-question').dataset.cid = 'fallback';
    document.getElementById('rv-captcha-question').dataset.ans = String(a+b);
  }

  async function submitReview(){
    const nameInput = document.getElementById('review-name');
    let name = localStorage.getItem(NAME_KEY);
    if(!name){
      if(!nameInput.value.trim()){ alert('Type your name'); return; }
      const cid = document.getElementById('rv-captcha-question').dataset.cid || '';
      const ans = document.getElementById('rv-captcha-answer').value.trim();
      if(!ans){ alert('Please answer captcha'); return; }
      if(serverAvailable){
        try{
          const res = await fetch(API_BASE, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({name: nameInput.value.trim(), text: "", captcha_id: cid, captcha_answer: ans})
          });
          const j = await res.json();
          if(!res.ok){ alert(j.error || 'Server refused'); return; }
          localStorage.setItem(NAME_KEY, nameInput.value.trim());
          if(j.delete_token && j.id) {
            const map = JSON.parse(localStorage.getItem(DELETE_MAP_KEY)||'{}');
            map[String(j.id)] = j.delete_token;
            localStorage.setItem(DELETE_MAP_KEY, JSON.stringify(map));
          }
          name = nameInput.value.trim();
          loadNameState();
        }catch(e){
          alert('Network error creating name; try again'); return;
        }
      } else {
        const expected = document.getElementById('rv-captcha-question').dataset.ans;
        if(String(ans) !== String(expected)){ alert('Captcha wrong'); return; }
        localStorage.setItem(NAME_KEY, nameInput.value.trim());
        name = nameInput.value.trim();
        loadNameState();
      }
    }

    const text = document.getElementById('review-text').value.trim();
    if(!text){ alert('Write review'); return; }

    document.getElementById('rv-publish').disabled = true;
    try {
      if(serverAvailable){
        const cid = document.getElementById('rv-captcha-question').dataset.cid || '';
        const ans = document.getElementById('rv-captcha-answer').value.trim();
        const payload = { name, text, captcha_id: cid, captcha_answer: ans };
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if(!res.ok){ alert(j.error || 'Publish failed'); serverAvailable = false; throw new Error('server failed'); }
        if(j.delete_token && j.id){
          const map = JSON.parse(localStorage.getItem(DELETE_MAP_KEY)||'{}');
          map[String(j.id)] = j.delete_token;
          localStorage.setItem(DELETE_MAP_KEY, JSON.stringify(map));
        }
        document.getElementById('review-text').value = '';
        await loadServerReviews();
        fetchCaptcha();
      } else {
        const arr = JSON.parse(localStorage.getItem(REV_KEY) || '[]');
        arr.unshift({ id: Date.now(), name, text, ts: Date.now() });
        localStorage.setItem(REV_KEY, JSON.stringify(arr.slice(0,500)));
        document.getElementById('review-text').value = '';
        loadFallbackReviews();
      }
    } catch(e){ console.error(e); }
    finally{ document.getElementById('rv-publish').disabled = false; }
  }

  async function loadServerReviews(){
    try{
      const res = await fetch(API_BASE + '?limit=500', {cache:'no-store'});
      if(!res.ok) throw new Error('no list');
      const j = await res.json();
      renderReviews(j.reviews || []);
    }catch(e){
      serverAvailable = false;
      loadFallbackReviews();
    }
  }

  function loadFallbackReviews(){
    const arr = JSON.parse(localStorage.getItem(REV_KEY) || '[]');
    renderReviews(arr);
  }

  function renderReviews(reviews){
    const root = document.getElementById('review-list');
    root.innerHTML = '';
    if(!reviews || !reviews.length){
      root.innerHTML = '<div style="color:var(--muted);font-size:13px;">No reviews yet.</div>';
      return;
    }
    const deleteMap = JSON.parse(localStorage.getItem(DELETE_MAP_KEY)||'{}');
    reviews.forEach(r=>{
      const id = r.id || r.ts || (r._id || Date.now());
      const ts = r.ts || r.ts || r.created_at || Date.now();
      const name = escapeHtml(r.name || 'Anon');
      const text = escapeHtml(r.text || '');
      const timeStr = new Date(ts).toLocaleString();
      const canDelete = (deleteMap[String(id)] || (!serverAvailable && (r.name && localStorage.getItem(NAME_KEY) === r.name)));
      const deleteButton = canDelete ? `<button data-id="${id}" class="rv-delete" style="float:right;margin-left:8px;background:transparent;border:none;color:brown;font-size:18px;cursor:pointer;">üóëÔ∏è</button>` : '';
      root.insertAdjacentHTML('beforeend',
        `<div style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);margin-bottom:8px;position:relative;">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
            <div style="font-weight:700;color:red;">${name}</div>
            <div style="font-size:12px;color:var(--muted);">${timeStr}</div>
          </div>
          <div style="margin-top:6px;color:var(--muted);white-space:pre-wrap;">${text}</div>
          <div style="position:absolute; right:12px; bottom:12px;">${deleteButton}</div>
        </div>`
      );
    });

    Array.from(document.querySelectorAll('.rv-delete')).forEach(btn=>{
      btn.addEventListener('click', onDeleteClick);
    });
  }

  async function onDeleteClick(ev){
    const id = ev.currentTarget.getAttribute('data-id');
    if(!confirm('Delete this review?')) return;

    const map = JSON.parse(localStorage.getItem(DELETE_MAP_KEY)||'{}');
    const token = map[String(id)];
    if(serverAvailable && token){
      try{
        const res = await fetch(API_BASE + '/' + encodeURIComponent(id), {
          method: 'DELETE',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ delete_token: token })
        });
        const j = await res.json();
        if(!res.ok){ alert(j.error || 'Delete failed'); return; }
        delete map[String(id)];
        localStorage.setItem(DELETE_MAP_KEY, JSON.stringify(map));
        await loadServerReviews();
        return;
      }catch(e){
        alert('Network error deleting'); return;
      }
    }

    if(!serverAvailable){
      const arr = JSON.parse(localStorage.getItem(REV_KEY)||'[]');
      const name = localStorage.getItem(NAME_KEY);
      const idx = arr.findIndex(x=>String(x.id) === String(id));
      if(idx === -1){ alert('Not found'); return; }
      if(name && arr[idx].name !== name){ alert('You can only delete your own review on this device'); return; }
      arr.splice(idx,1);
      localStorage.setItem(REV_KEY, JSON.stringify(arr));
      loadFallbackReviews();
      return;
    }

    alert('Cannot delete: delete token missing.');
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

  document.getElementById('rv-new-captcha').addEventListener('click', function(e){ fetchCaptcha(); });

  (function attachToReviewLink(){ /* openReview used by anchor */ })();

</script>

{% endblock %}
